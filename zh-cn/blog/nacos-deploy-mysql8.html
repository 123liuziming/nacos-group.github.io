<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="mysql8,nacos" />
	<meta name="description" content="Nacos 配置MySQL8数据库" />
	<!-- 网页标签标题 -->
	<title>Nacos 配置MySQL8数据库</title>
	<link rel="shortcut icon" href="https://img.alicdn.com/tfs/TB1hgJpHAPoK1RjSZKbXXX1IXXa-64-64.png"/>
	<link rel="stylesheet" href="/build/blogDetail.css" />
</head>
<body>
	<div id="root"><div class="blog-detail-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/zh-cn/index.html"><img class="logo" src="/img/nacos_colorful.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">En</span><div class="header-menu"><img class="header-menu-toggle" src="/img/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="/zh-cn/index.html">首页</a></li><li class="menu-item menu-item-normal"><a href="/zh-cn/docs/what-is-nacos.html">文档</a></li><li class="menu-item menu-item-normal"><a href="/zh-cn/docs/nacos-dev.html">开发者团队</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/zh-cn/blog/index.html">博客</a></li><li class="menu-item menu-item-normal"><a href="/zh-cn/community/index.html">社区</a></li><li class="menu-item menu-item-normal"><a href="https://mp.weixin.qq.com/s/KH0dEC6cNckoq1M-siiCmg">阿里中间件-校园招聘</a></li><li class="menu-item menu-item-normal"><a href="http://console.nacos.io/nacos/index.html">控制台样例</a></li></ul></div></div></header><section class="blog-content markdown-body"><h1>Nacos 配置MySQL8数据库</h1>
<p><code>Nacos版本：1.1.3</code></p>
<p><code>MySQL版本：8.0.15</code></p>
<h2>从GitHub上获取Nacos源码</h2>
<pre><code class="language-sh">git <span class="hljs-built_in">clone</span> https://github.com/alibaba/nacos.git
</code></pre>
<h2>初始化mysql数据库</h2>
<p><code>脚本文件位置：nacos/distribution/conf/nacos-mysql.sql</code></p>
<pre><code class="language-mysql">-- 创建nacos_config数据库
create database `nacos_config` default character set utf8mb4 collate utf8mb4_general_ci;
use `nacos_config`;
</code></pre>
<h2>修改pom文件里的mysql驱动版本</h2>
<p><code>位置：在父pom文件中，line 643</code></p>
<pre><code class="language-xml"><span class="hljs-comment">&lt;!-- JDBC libs --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- &lt;version&gt;5.1.34&lt;/version&gt; --&gt;</span>
    <span class="hljs-comment">&lt;!-- 更换为支持MySQL8驱动的版本 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.17<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h2>修改源代码</h2>
<p><code>修改数据源</code></p>
<p><code>位置：nacos/naming/src/main/java/com/alibaba/nacos/naming/healthcheck/MysqlHealthCheckProcessor.java</code></p>
<pre><code class="language-java"><span class="hljs-comment">// import com.mysql.jdbc.jdbc2.optional.MysqlDataSource;原本引用的类</span>
<span class="hljs-comment">// com.mysql.cj.jdbc.MysqlDataSource是通过定位源码的位置找到的</span>
<span class="hljs-keyword">import</span> com.mysql.cj.jdbc.MysqlDataSource;
</code></pre>
<h2>修改配置文件，添加支持mysql数据源配置</h2>
<p><code>配置文件位置：nacos/distribution/conf/application.properties</code></p>
<pre><code class="language-properties"><span class="hljs-meta">spring.datasource.platform</span>=<span class="hljs-string">mysql</span>
<span class="hljs-meta">spring.datasource.driver-class-name</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
<span class="hljs-meta">db.num</span>=<span class="hljs-string">1</span>
<span class="hljs-meta">db.url.0</span>=<span class="hljs-string">jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true</span>
<span class="hljs-meta">db.user</span>=<span class="hljs-string">userName</span>
<span class="hljs-meta">db.password</span>=<span class="hljs-string">password</span>
</code></pre>
<h2>打包编译</h2>
<pre><code class="language-shell">cd nacos/
mvn -Prelease-nacos clean install -U -Dmaven.test.skip=true
</code></pre>
<h2>Linux环境下单机模式启动命令</h2>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> 单机模式启动</span>
nohup sh startup.sh -m standalone &amp;
<span class="hljs-meta">
#</span><span class="bash"> 查看启动日志</span>
vim /usr/local/nacos/distribution/target/nacos-server-1.1.3/nacos/logs/start.out
</code></pre>
<h2>问题排查</h2>
<p><code>问题</code></p>
<pre><code class="language-tex">Caused by: java.lang.NullPointerException at com.mysql.jdbc.ConnectionImpl.getServerCharset(ConnectionImpl.java:2983)
</code></pre>
<p><code>分析：源代码与使用的Mysql8驱动不一致导致，参考上面的更换驱动部分</code></p>
<p><code>问题</code></p>
<pre><code class="language-tex">[ERROR] nacos/naming/src/main/java/com/alibaba/nacos/naming/healthcheck/MysqlHealthCheckProcessor.java:[24,37] 程序包com.mysql.jdbc.jdbc2.optional不存在
</code></pre>
<p><code>分析：由于pom文件更改了mysql驱动版本，所以源代码也需要作出相应改动，参考上面的修改源代码部分</code></p>
</section><footer class="footer-container"><div class="footer-body"><img src="/img/nacos_gray.png"/><div class="cols-container"><div class="col col-12"><h3>愿景</h3><p>Nacos 通过提供简单易用的动态服务发现、服务配置、服务共享与管理等服务基础设施，帮助用户在云原生时代，在私有云、混合云或者公有云等所有云环境中，更好的构建、交付、管理自己的微服务平台，更快的复用和组合业务服务，更快的交付商业创新的价值，从而为用户赢得市场。</p></div><div class="col col-6"><dl><dt>文档</dt><dd><a href="/zh-cn/docs/what-is-nacos.html" target="_self">概览</a></dd><dd><a href="/zh-cn/docs/quick-start.html" target="_self">快速开始</a></dd><dd><a href="/zh-cn/docs/contributing.html" target="_self">开发者指南</a></dd></dl></div><div class="col col-6"><dl><dt>资源</dt><dd><a href="/zh-cn/community/index.html" target="_self">社区</a></dd><dd><a href="https://www.aliyun.com/product/acm?source_type=nacos_pc_20181219" target="_self">云服务 ACM</a></dd><dd><a href="https://www.aliyun.com/product/edas?source_type=nacos_pc_20181219" target="_self">云服务 EDAS</a></dd><dd><a href="https://www.aliyun.com/product/ahas?source_type=nacos_pc_20190225" target="_self">云服务 AHAS</a></dd></dl></div></div><div class="copyright"><span>@ 2018 The Nacos Authors | An Alibaba Middleware (Aliware) Project</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
  </script>
	<script src="/build/blogDetail.js"></script>
</body>
</html>