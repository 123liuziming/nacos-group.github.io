<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="use-nacos-with-kubernetes" />
	<meta name="description" content="use-nacos-with-kubernetes" />
	<!-- 网页标签标题 -->
	<title>use-nacos-with-kubernetes</title>
	<link rel="shortcut icon" href="https://img.alicdn.com/tfs/TB1hgJpHAPoK1RjSZKbXXX1IXXa-64-64.png"/>
	<link rel="stylesheet" href="/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/zh-cn/index.html"><img class="logo" src="/img/nacos_colorful.png"/></a><span class="language-switch language-switch-normal">En</span><div class="header-menu"><img class="header-menu-toggle" src="/img/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="/zh-cn/index.html">首页</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/zh-cn/docs/what-is-nacos.html">文档</a></li><li class="menu-item menu-item-normal"><a href="/zh-cn/blog/index.html">博客</a></li><li class="menu-item menu-item-normal"><a href="/zh-cn/community/index.html">社区</a></li><li class="menu-item menu-item-normal"><a href="http://console.nacos.io/nacos/index.html">控制台样例</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/img/docs.png" class="front-img"/><div class="bar-title"><span>Nacos 文档</span><div class="bone bone-light"></div></div><img src="/img/docs.png" class="back-img"/></div></div><section class="content-section"><div class="content-body"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>Nacos </span><ul><li style="height:180px;overflow:hidden" class="menu-item menu-item-level-2"><span>Nacos是什么?<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/what-is-nacos.html" target="_self">Nacos简介</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/concepts.html" target="_self">概念</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/architecture.html" target="_self">架构</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/FAQ.html" target="_self">FAQ</a></li></ul></li><li style="height:288px;overflow:hidden" class="menu-item menu-item-level-2"><span>快速开始<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/quick-start.html" target="_self">快速开始</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/quick-start-spring.html" target="_self">Nacos Spring</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/quick-start-spring-boot.html" target="_self">Nacos Spring Boot</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/quick-start-spring-cloud.html" target="_self">Nacos Spring Cloud</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/quick-start-docker.html" target="_self">Nacos Docker</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/use-nacos-with-dubbo.html" target="_self">Nacos Dubbo</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/use-nacos-with-kubernetes.html" target="_self">Nacos k8s</a></li></ul></li><li style="height:180px;overflow:hidden" class="menu-item menu-item-level-2"><span>用户指南<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/sdk.html" target="_self">Java的SDK</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/other-language.html" target="_self">其他语言的SDK</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/open-API.html" target="_self">Open-API指南</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/nacos-spring.html" target="_self">Nacos Spring</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>运维指南<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/deployment.html" target="_self">部署手册</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/cluster-mode-quick-start.html" target="_self">集群部署说明</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/managementAPI.html" target="_self">运维API</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/console-guide.html" target="_self">控制台手册</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/monitor-guide.html" target="_self">监控手册</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/nacos-config-benchmark.html" target="_self">配置模块压测模型</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>开源共建<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/contributing.html" target="_self">贡献源码</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/activity.html" target="_self">Nacos有奖活动介绍</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/pull-request.html" target="_self">pull request模板</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/how-to-reporting-bugs.html" target="_self">如何提交问题报告</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/roadmap.html" target="_self">Nacos规划</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/use-nacos-with-istio.html" target="_self">nacos支持istio</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>社区<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/community.html" target="_self">社区</a></li></ul></li></ul></li></ul></div><div class="doc-content markdown-body"><h1>Kubernetes Nacos</h1>
<p>This project contains a Nacos Docker image meant to facilitate the deployment of <a href="https://nacos.io">Nacos</a> on <a href="https://kubernetes.io/">Kubernetes</a> via StatefulSets.</p>
<p><a href="https://github.com/nacos-group/nacos-k8s/blob/master/README-CN.md">中文文档</a></p>
<h1>Quick Start</h1>
<ul>
<li><strong>Clone Project</strong></li>
</ul>
<pre><code class="language-shell">git clone https://github.com/nacos-group/nacos-k8s.git
</code></pre>
<ul>
<li><strong>Simple Start</strong></li>
</ul>
<blockquote>
<p>If you want to start Nacos without NFS, but <strong>emptyDirs will possibly result in a loss of data</strong>. as follows:</p>
</blockquote>
<pre><code class="language-shell">cd nacos-k8s
chmod +x quick-startup.sh
./quick-startup.sh
</code></pre>
<ul>
<li>
<p><strong>Testing</strong></p>
<ul>
<li><strong>Service registration</strong></li>
</ul>
<pre><code class="language-powershell">curl -X PUT <span class="hljs-string">'http://cluster-ip:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080'</span>
</code></pre>
<ul>
<li><strong>Service discovery</strong></li>
</ul>
<pre><code class="language-powershell">curl -X GET <span class="hljs-string">'http://cluster-ip:8848/nacos/v1/ns/instances?serviceName=nacos.naming.serviceName'</span>
</code></pre>
<ul>
<li><strong>Publish config</strong></li>
</ul>
<pre><code class="language-powershell">curl -X POST <span class="hljs-string">"http://cluster-ip:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;content=helloWorld"</span>
</code></pre>
<ul>
<li><strong>Get config</strong></li>
</ul>
<pre><code class="language-powershell">curl -X GET <span class="hljs-string">"http://cluster-ip:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test"</span>
</code></pre>
</li>
</ul>
<h1>Advanced</h1>
<blockquote>
<p>In advanced use, the cluster is automatically scaled and data is persisted, but <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims">PersistentVolumeClaims</a> must be deployed. In this example, NFS is used.</p>
</blockquote>
<h2>Deploy NFS</h2>
<ul>
<li>Create Role</li>
</ul>
<pre><code class="language-shell">kubectl create -f deploy/nfs/rbac.yaml
</code></pre>
<blockquote>
<p>If your K8S namespace is not default, execute the following script before creating RBAC</p>
</blockquote>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> Set the subject of the RBAC objects to the current namespace <span class="hljs-built_in">where</span> the provisioner is being deployed</span>
<span class="hljs-meta">$</span><span class="bash"> NS=$(kubectl config get-contexts|grep -e <span class="hljs-string">"^\*"</span> |awk <span class="hljs-string">'{print $5}'</span>)</span>
<span class="hljs-meta">$</span><span class="bash"> NAMESPACE=<span class="hljs-variable">${NS:-default}</span></span>
<span class="hljs-meta">$</span><span class="bash"> sed -i<span class="hljs-string">''</span> <span class="hljs-string">"s/namespace:.*/namespace: <span class="hljs-variable">$NAMESPACE</span>/g"</span> ./deploy/nfs/rbac.yaml</span>

</code></pre>
<ul>
<li>Create <code>ServiceAccount</code> And deploy <code>NFS-Client Provisioner</code></li>
</ul>
<pre><code class="language-shell">kubectl create -f deploy/nfs/deployment.yaml
</code></pre>
<ul>
<li>Create NFS StorageClass</li>
</ul>
<pre><code class="language-shell">kubectl create -f deploy/nfs/class.yaml
</code></pre>
<ul>
<li>Verify that NFS is working</li>
</ul>
<pre><code class="language-shell">kubectl get pod -l app=nfs-client-provisioner
</code></pre>
<h2>Deploy database</h2>
<ul>
<li>Deploy master</li>
</ul>
<pre><code class="language-shell">
cd nacos-k8s

kubectl create -f deploy/mysql/mysql-master-nfs.yaml
</code></pre>
<ul>
<li>Deploy slave</li>
</ul>
<pre><code class="language-shell">
cd nacos-k8s 

kubectl create -f deploy/mysql/mysql-slave-nfs.yaml
</code></pre>
<ul>
<li>Verify that Database is working</li>
</ul>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> master</span>
kubectl get pod 
NAME                         READY   STATUS    RESTARTS   AGE
mysql-master-gf2vd                        1/1     Running   0          111m
<span class="hljs-meta">
#</span><span class="bash"> slave</span>
kubectl get pod 
mysql-slave-kf9cb                         1/1     Running   0          110m
</code></pre>
<h2>Deploy Nacos</h2>
<ul>
<li>Modify  <strong>depoly/nacos/nacos-pvc-nfs.yaml</strong></li>
</ul>
<pre><code class="language-yaml"><span class="hljs-attr">data:</span>
  <span class="hljs-string">mysql.master.db.name:</span> <span class="hljs-string">"db name"</span>
  <span class="hljs-string">mysql.master.port:</span> <span class="hljs-string">"master db port"</span>
  <span class="hljs-string">mysql.slave.port:</span> <span class="hljs-string">"slave db port"</span>
  <span class="hljs-string">mysql.master.user:</span> <span class="hljs-string">"master db username"</span>
  <span class="hljs-string">mysql.master.password:</span> <span class="hljs-string">"master db password"</span>
</code></pre>
<ul>
<li>Create Nacos</li>
</ul>
<pre><code class="language-shell">kubectl create -f nacos-k8s/deploy/nacos/nacos-pvc-nfs.yaml
</code></pre>
<ul>
<li>Verify that Nacos is working</li>
</ul>
<pre><code class="language-shell">kubectl get pod -l app=nacos


NAME      READY   STATUS    RESTARTS   AGE
nacos-0   1/1     Running   0          19h
nacos-1   1/1     Running   0          19h
nacos-2   1/1     Running   0          19h
</code></pre>
<h2>Scale Testing</h2>
<ul>
<li>Use <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#exec"><code>kubectl exec</code></a> to get the cluster config of the Pods in the <code>nacos</code> StatefulSet.</li>
</ul>
<pre><code class="language-powershell"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span>; <span class="hljs-keyword">do</span> echo nacos-<span class="hljs-variable">$i</span>; kubectl exec nacos-<span class="hljs-variable">$i</span> cat conf/cluster.conf; done
</code></pre>
<p>The StatefulSet controller provides each Pod with a unique hostname based on its ordinal index. The hostnames take the form of <code>&lt;statefulset name&gt;-&lt;ordinal index&gt;</code>. Because the <code>replicas</code> field of the <code>nacos</code> StatefulSet is set to <code>2</code>, In the cluster file only two nacos address</p>
<p><img src="/images/k8s.gif" alt="k8s"></p>
<ul>
<li>Use kubectl to scale StatefulSets</li>
</ul>
<pre><code class="language-bash">kubectl scale sts nacos --replicas=3
</code></pre>
<p><img src="/images/scale.gif" alt="scale"></p>
<ul>
<li>Use <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#exec"><code>kubectl exec</code></a> to get the cluster config of the Pods in the <code>nacos</code> StatefulSet after scale StatefulSets</li>
</ul>
<pre><code class="language-bash"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> 0 1 2; <span class="hljs-keyword">do</span> <span class="hljs-built_in">echo</span> nacos-<span class="hljs-variable">$i</span>; kubectl <span class="hljs-built_in">exec</span> nacos-<span class="hljs-variable">$i</span> cat conf/cluster.conf; <span class="hljs-keyword">done</span>
</code></pre>
<p><img src="/images/get_cluster_after.gif" alt="get_cluster_after"></p>
<ul>
<li>Use <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#exec"><code>kubectl exec</code></a> to get the <strong>state</strong> of the Pods in the <code>nacos</code> StatefulSet after scale StatefulSets</li>
</ul>
<pre><code class="language-bash"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> 0 1 2; <span class="hljs-keyword">do</span> <span class="hljs-built_in">echo</span> nacos-<span class="hljs-variable">$i</span>; kubectl <span class="hljs-built_in">exec</span> nacos-<span class="hljs-variable">$i</span> curl GET <span class="hljs-string">"http://localhost:8848/nacos/v1/ns/raft/state"</span>; <span class="hljs-keyword">done</span>
</code></pre>
<p>You can find that the new node has joined the cluster</p>
<h1>Environment</h1>
<ul>
<li>Machine configuration</li>
</ul>
<table>
<thead>
<tr>
<th>Intranet IP</th>
<th>Hostname</th>
<th>Configuration</th>
</tr>
</thead>
<tbody>
<tr>
<td>172.17.79.3</td>
<td>k8s-master</td>
<td>CentOS Linux release 7.4.1708 (Core) Single-core processor Mem 4G Cloud disk 40G</td>
</tr>
<tr>
<td>172.17.79.4</td>
<td>node01</td>
<td>CentOS Linux release 7.4.1708 (Core) Single-core processor Mem 4G Cloud disk 40G</td>
</tr>
<tr>
<td>172.17.79.5</td>
<td>node02</td>
<td>CentOS Linux release 7.4.1708 (Core) Single-core processor Mem 4G Cloud disk 40G</td>
</tr>
</tbody>
</table>
<ul>
<li>Kubernetes 版本：<strong>1.12.2</strong> （如果你和我一样只使用了三台机器,那么记得开启master节点的部署功能）</li>
<li>NFS 版本：<strong>4.1</strong> 在k8s-master进行安装Server端,并且指定共享目录,本项目指定的**/data/nfs-share**</li>
<li>Git</li>
</ul>
<h1>Limitations</h1>
<ul>
<li>Persistent Volumes must be used. emptyDirs will possibly result in a loss of data</li>
</ul>
<h1>Project directory</h1>
<table>
<thead>
<tr>
<th>Directory Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>plugin</td>
<td>Help Nacos cluster achieve automatic scaling in K8s</td>
</tr>
<tr>
<td>deploy</td>
<td>Deploy the required files</td>
</tr>
</tbody>
</table>
<h1>Configuration properties</h1>
<ul>
<li>nacos-pvc-nfs.yaml or nacos-quick-start.yaml</li>
</ul>
<table>
<thead>
<tr>
<th>Name</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://mysql.master.db.name">mysql.master.db.name</a></td>
<td>Y</td>
<td>Master database name</td>
</tr>
<tr>
<td>mysql.master.port</td>
<td>N</td>
<td>Master database port</td>
</tr>
<tr>
<td>mysql.slave.port</td>
<td>N</td>
<td>Slave database port</td>
</tr>
<tr>
<td>mysql.master.user</td>
<td>Y</td>
<td>Master database username</td>
</tr>
<tr>
<td>mysql.master.password</td>
<td>Y</td>
<td>Master database password</td>
</tr>
<tr>
<td>NACOS_REPLICAS</td>
<td>Y</td>
<td>The number of clusters must be consistent with the value of the replicas attribute</td>
</tr>
<tr>
<td>NACOS_SERVER_PORT</td>
<td>N</td>
<td>Nacos port,default:8848</td>
</tr>
<tr>
<td>PREFER_HOST_MODE</td>
<td>Y</td>
<td>Enable Nacos cluster node domain name support</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>nfs</strong> deployment.yaml</li>
</ul>
<table>
<thead>
<tr>
<th>Name</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>NFS_SERVER</td>
<td>Y</td>
<td>NFS server address</td>
</tr>
<tr>
<td>NFS_PATH</td>
<td>Y</td>
<td>NFS server shared directory</td>
</tr>
<tr>
<td>server</td>
<td>Y</td>
<td>NFS server address</td>
</tr>
<tr>
<td>path</td>
<td>Y</td>
<td>NFS server shared directory</td>
</tr>
</tbody>
</table>
<ul>
<li>mysql yaml</li>
</ul>
<table>
<thead>
<tr>
<th>Name</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>MYSQL_ROOT_PASSWORD</td>
<td>N</td>
<td>Root password</td>
</tr>
<tr>
<td>MYSQL_DATABASE</td>
<td>Y</td>
<td>Database Name</td>
</tr>
<tr>
<td>MYSQL_USER</td>
<td>Y</td>
<td>Database Username</td>
</tr>
<tr>
<td>MYSQL_PASSWORD</td>
<td>Y</td>
<td>Database Password</td>
</tr>
<tr>
<td>MYSQL_REPLICATION_USER</td>
<td>Y</td>
<td>Master-slave replication username</td>
</tr>
<tr>
<td>MYSQL_REPLICATION_PASSWORD</td>
<td>Y</td>
<td>Master-slave replication password</td>
</tr>
<tr>
<td>Nfs:server</td>
<td>Y</td>
<td>NFS server address</td>
</tr>
<tr>
<td>Nfs:path</td>
<td>Y</td>
<td>NFS server shared path</td>
</tr>
</tbody>
</table>
</div></div></section><footer class="footer-container"><div class="footer-body"><img src="/img/nacos_gray.png"/><div class="cols-container"><div class="col col-12"><h3>愿景</h3><p>Nacos 通过提供简单易用的动态服务发现、服务配置、服务共享与管理等服务基础设施，帮助用户在云原生时代，在私有云、混合云或者公有云等所有云环境中，更好的构建、交付、管理自己的微服务平台，更快的复用和组合业务服务，更快的交付商业创新的价值，从而为用户赢得市场。</p></div><div class="col col-6"><dl><dt>文档</dt><dd><a href="/zh-cn/docs/what-is-nacos.html" target="_self">概览</a></dd><dd><a href="/zh-cn/docs/quick-start.html" target="_self">快速开始</a></dd><dd><a href="/zh-cn/docs/contributing.html" target="_self">开发者指南</a></dd></dl></div><div class="col col-6"><dl><dt>资源</dt><dd><a href="/zh-cn/community/index.html" target="_self">社区</a></dd><dd><a href="https://www.aliyun.com/product/acm?source_type=nacos_pc_20181219" target="_self">云服务 ACM</a></dd><dd><a href="https://www.aliyun.com/product/edas?source_type=nacos_pc_20181219" target="_self">云服务 EDAS</a></dd><dd><a href="https://www.aliyun.com/product/ahas?source_type=nacos_pc_20190225" target="_self">云服务 AHAS</a></dd></dl></div></div><div class="copyright"><span>@ 2018 The Nacos Authors | An Alibaba Middleware (Aliware) Project</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
  </script>
	<script src="/build/documentation.js"></script>
</body>
</html>