---
id: "question-history-8288"
title: "在1.4.x版本，Distro协议可以把心跳和注册的流量压力分散到集群的各个节点。但是在2.x版本，由于建立的通信通道是长连接，Distro协议不再分散流量到集群内，而是直接对请求进行处理。故障场景：如果要对集群节点进行灰度升级的话，客户端会从下线的节点切换到别的节点，切换后建立的又是长链接，由于服务端节点是灰度进行的(逐台进行)，会不会最后导致压力全部连接到集群中的一台或者两台，造成数据倾斜的问题？异常表现：个别节点内存和CPU占用极高，其他节点负载很低。问题：客户端或者服务端有措施可以规避或者预防这种情况发生吗？ nacos-opensource"
date: "2024-04-23"
category: expertConsultation
description: "nacos-opensource 在1.4.x版本，Distro协议可以把心跳和注册的流量压力分散到集群的各个节点。但是在2.x版本，由于建立的通信通道是长连接，Distro协议不再分散流量到集群内，而是直接对请求进行处理。故障场景：如果要对集群节点进行灰度升级的话，客户端会从下线的节点切换到别的节点，切换后建立的又是长链接，由于服务端节点是灰度进行的(逐台进行)，会不会最后导致压力全部连接到集群中的一台或者两台，造成数据倾斜的问题？异常表现：个别节点内存和CPU占用极高，其他节点负载很低。问题：客户端或者服务端有措施可以规避或者预防这种情况发生吗？"
tags: ["1.4.x版本","Distro协议","心跳","注册","流量压力","分散","集群节点","2.x版本","长连接","通信通道","故障场景","灰度升级","客户端","下线节点","切换","服务端节点","灰度进行","数据倾斜","异常表现","个别节点","内存","CPU占用","极高","其他节点","负载","很低","客户端","服务端","措施","规避","预防"]
keywords: ["1.4.x版本","Distro协议","心跳","注册","流量压力","分散","集群节点","2.x版本","长连接","通信通道","故障场景","灰度升级","客户端","下线节点","切换","服务端节点","灰度进行","数据倾斜","异常表现","个别节点","内存","CPU占用","极高","其他节点","负载","很低","客户端","服务端","措施","规避","预防"]
---

## 用户问题 ： 
 在1.4.x版本，Distro协议可以把心跳和注册的流量压力分散到集群的各个节点。但是在2.x版本，由于建立的通信通道是长连接，Distro协议不再分散流量到集群内，而是直接对请求进行处理。故障场景：如果要对集群节点进行灰度升级的话，客户端会从下线的节点切换到别的节点，切换后建立的又是长链接，由于服务端节点是灰度进行的(逐台进行)，会不会最后导致压力全部连接到集群中的一台或者两台，造成数据倾斜的问题？异常表现：个别节点内存和CPU占用极高，其他节点负载很低。问题：客户端或者服务端有措施可以规避或者预防这种情况发生吗？ nacos-opensource 

---------------
## 专家官方解答 ：

针对您提出的关于Nacos 2.x版本在灰度升级过程中可能导致数据倾斜的问题，我们可以依托已有的知识进行原因分析，并参考给出的解决方案。

**原因分析：**

在Nacos 2.x版本中，由于客户端与服务端之间建立了长连接通信通道，客户端在服务端节点灰度升级过程中会从下线节点切换至其他节点。这种逐台进行的灰度升级方式可能导致新连接集中于少量未升级的节点，进而造成这些节点承受过高的流量压力，表现为内存、CPU占用极高，形成数据倾斜现象，而其他节点则负载较低。

**预防与应对措施：**

根据已有的知识，可以采取以下步骤来规避或缓解此类情况：

1. **使用VIP/SLB进行负载均衡：**
   部署Nacos集群时，通过挂载VIP（虚拟IP）或使用SLB（负载均衡器），将客户端请求分发至集群中的各个节点。VIP/SLB通常支持多种负载均衡算法，如最小连接数算法，能够在短时间内实现连接的均匀分布。这样，即使在灰度升级过程中，新连接也能被有效地分散到不同节点，避免数据倾斜。

2. **主动触发负载均衡：**
   对于连接数量较多的节点，可以调用接口 `curl -X GET '127.0.0.1:8848/nacos/v2/core/loader/reloadCurrent?count=xxx'` 来主动迁移部分连接至其他节点。其中，`count` 参数指定需要迁移的连接数。通过适时执行此操作，可以在服务端节点灰度升级期间动态调整各节点的连接分布，确保整体负载均衡。

3. **合理规划灰度升级策略：**
   考虑采用更平滑的灰度升级策略，如分批、交错升级节点，以减小单次切换导致的连接集中效应。同时，密切监控集群状态，确保在升级过程中及时发现并调整负载不均的问题。

综上所述，通过运用VIP/SLB进行负载均衡、主动触发负载均衡操作，以及优化灰度升级策略，可以有效规避或预防Nacos 2.x版本在灰度升级过程中因长连接导致的数据倾斜问题。


<font color="#949494">---------------</font> 


## 参考链接 ：

*专家经验:Nacos负载均衡问题 
 
 *专家经验:CatalogController 里面的接口和客户端SDK的API区别是什么 
 
 *专家经验:Nacos部署开放端口，集群部署开通端口 


 <font color="#949494">---------------</font> 
 


## <font color="#FF0000">答疑服务说明：</font> 

本内容经由技术专家审阅的用户问答的镜像生成，我们提供了<font color="#FF0000">专家智能答疑服务</font>，在<font color="#FF0000">页面的右下的浮窗”专家答疑“</font>。您也可以访问 : [全局专家答疑](https://opensource.alibaba.com/chatBot) 。 咨询其他产品的的问题

### 反馈
如问答有错漏，欢迎点：[差评](https://ai.nacos.io/user/feedbackByEnhancerGradePOJOID?enhancerGradePOJOId=11593)给我们反馈。
