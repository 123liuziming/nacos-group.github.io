---
id: "question-history-8185"
title: "服务多实例进行滚动更新重启中断 nacos-opensource"
date: "2024-04-23"
category: expertConsultation
description: "nacos-opensource 服务多实例进行滚动更新重启中断"
tags: ["服务","多实例","滚动更新","重启","中断"]
keywords: ["服务","多实例","滚动更新","重启","中断"]
---

## 用户问题 ： 
 服务多实例进行滚动更新重启中断 nacos-opensource 

---------------
## 专家官方解答 ：

在进行基于nacos-opensource的服务多实例滚动更新重启过程中遇到中断问题，根据提供的知识，其可能的原因包括：

1. **服务提供者未彻底关闭**：进程依然存在并发送心跳维持连接，导致Nacos未能正确摘除服务提供者。
2. **触发推空保护**：服务提供者全部下线后，由于推空保护机制，Nacos未及时推送空列表给消费者。
3. **网络或订阅者应用问题**：导致Nacos-Client无法获取到最新的服务提供者地址。
4. **应用未使用最新地址**：Nacos-Client虽已获取到新地址，但应用因路由规则、权重规则、框架缓存等原因未使用。
5. **Nacos-Client和Server版本过旧**：导致发现速度慢，影响服务切换。

针对以上可能的原因，结合知识中提供的解决方案，以下是针对服务多实例滚动更新重启中断问题的详细处理步骤：

**步骤一：检查Nacos控制台**

1.1. **确认服务提供者状态**：登录Nacos控制台，检查目标服务的提供者列表，看是否存在已下线的服务实例仍在列表中。

   - **若存在**：进一步排查进程是否确实已停止（特别是在Kubernetes环境下，核实Pod状态及节点上是否存在残留进程）。同时，检查是否存在其他进程（如代理注册）仍在发送心跳维持服务提供者的连接。

   - **若不存在**：判断是否触发了推空保护。若服务下无其他可用实例，考虑临时关闭推空保护（Java客户端设置`namingPushEmptyProtection=false`），或者重新发布一个该服务提供者以恢复正常服务发现。

**步骤二：分析中断时间和服务实例情况**

2.1. **中断时间短（≤10秒）**：可能存在Nacos-Client版本为1.X，建议升级到2.X版本以缩短发现速度至约1秒。

2.2. **中断时间较长但能自愈**：可能是应用框架（如Spring Cloud的Feign、LoadBalancer、Ribbon等）内部缓存更新频率较低导致。此时，需检查并适当调整框架缓存刷新策略，确保及时使用Nacos推送的新地址。

2.3. **长时间中断且无法自愈**：可能存在Nacos-Client、应用或网络故障。检查Nacos-Client和应用日志，定位获取新地址失败或不使用新地址的具体原因。例如，对于Dubbo 2.7.7~2.7.16可能存在多订阅问题，建议升级至更高版本。

**步骤三：版本升级与排查**

- **升级Nacos-Client**：确保使用最新稳定版，以提升服务发现性能和稳定性。

- **升级应用框架**：如存在已知版本问题（如前述Dubbo多订阅问题），及时升级至修复版本。

- **网络与资源检查**：排除网络故障或资源限制等因素导致的Nacos-Client无法正常工作。

**步骤四：监控与日志分析**

在整个排查过程中，持续关注Nacos控制台、Nacos-Client和应用的日志，以便及时捕捉异常情况。同时，加强服务发现过程的监控，设置告警阈值，以便在发生类似中断时迅速响应。

综上所述，针对nacos-opensource服务多实例滚动更新重启中断问题，我们首先通过Nacos控制台排查服务提供者状态，分析中断时间和服务实例情况，然后采取相应的版本升级、缓存刷新策略调整、网络与资源检查等措施，并加强监控与日志分析，以期有效解决中断问题。


<font color="#949494">---------------</font> 


## 参考链接 ：

*[Nacos 融合 Spring Cloud，成为注册配置中心](https://nacos.io/docs/latest/ecology/use-nacos-with-spring-cloud)
 
 *专家经验:服务提供者已关闭，但是还在被其他应用调用 


 <font color="#949494">---------------</font> 
 


## <font color="#FF0000">答疑服务说明：</font> 

本内容经由技术专家审阅的用户问答的镜像生成，我们提供了<font color="#FF0000">专家智能答疑服务</font>，在<font color="#FF0000">页面的右下的浮窗”专家答疑“</font>。您也可以访问 : [全局专家答疑](https://opensource.alibaba.com/chatBot) 。 咨询其他产品的的问题

### 反馈
如问答有错漏，欢迎点：[差评](https://ai.nacos.io/user/feedbackByEnhancerGradePOJOID?enhancerGradePOJOId=11507)给我们反馈。
