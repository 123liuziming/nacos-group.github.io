---
id: "question-history-8429"
title: "大佬我想请教下，我们的4个应用服务和nacos服务分别部署在三台服务器上并且都使用docker部署，也就是应用服务和nacos server 都是三个节点，在做高可用测试的时候，模拟服务器断电后重启的情况，我们reboot其中一台A服务器，并且停掉C服务器上的nacos server节点，这时候应该只有B服务器上的nacos 节点是UP的状态，A服务器的nacos状态应该是先从UP变成SUSPICOUS 再变成 DOWN ,最后恢复成UP , 但是我们A服务器上的业务应用在开机自启动的时候，有出现服务注册不了的情况，按道理这时候A服务器上的业务应用的责任节点应该都重新分配到B的nacos节点上了才对，但是看nacos server的日志报了一个receive invalid redirect request from peer {ip} ,这种看源码应该是两个nacos节点计算责任节点出现不一致导致的，但是这里我一直搞不明白为什么会出现这种不一致？ nacos-opensource"
date: "2024-04-23"
category: expertConsultation
description: "nacos-opensource 大佬我想请教下，我们的4个应用服务和nacos服务分别部署在三台服务器上并且都使用docker部署，也就是应用服务和nacos server 都是三个节点，在做高可用测试的时候，模拟服务器断电后重启的情况，我们reboot其中一台A服务器，并且停掉C服务器上的nacos server节点，这时候应该只有B服务器上的nacos 节点是UP的状态，A服务器的nacos状态应该是先从UP变成SUSPICOUS 再变成 DOWN ,最后恢复成UP , 但是我们A服务器上的业务应用在开机自启动的时候，有出现服务注册不了的情况，按道理这时候A服务器上的业务应用的责任节点应该都重新分配到B的nacos节点上了才对，但是看nacos server的日志报了一个receive invalid redirect request from peer {ip} ,这种看源码应该是两个nacos节点计算责任节点出现不一致导致的，但是这里我一直搞不明白为什么会出现这种不一致？"
tags: ["应用服务","nacos服务","服务器","docker","节点","高可用测试","断电","重启","模拟","reboot","停掉","UP","SUSPICOUS","DOWN","恢复","业务应用","服务注册","责任节点","重新分配","nacos节点","日志","invalid redirect request","peer","源码","计算责任节点","不一致"]
keywords: ["应用服务","nacos服务","服务器","docker","节点","高可用测试","断电","重启","模拟","reboot","停掉","UP","SUSPICOUS","DOWN","恢复","业务应用","服务注册","责任节点","重新分配","nacos节点","日志","invalid redirect request","peer","源码","计算责任节点","不一致"]
---

## 用户问题 ： 
 大佬我想请教下，我们的4个应用服务和nacos服务分别部署在三台服务器上并且都使用docker部署，也就是应用服务和nacos server 都是三个节点，在做高可用测试的时候，模拟服务器断电后重启的情况，我们reboot其中一台A服务器，并且停掉C服务器上的nacos server节点，这时候应该只有B服务器上的nacos 节点是UP的状态，A服务器的nacos状态应该是先从UP变成SUSPICOUS 再变成 DOWN ,最后恢复成UP , 但是我们A服务器上的业务应用在开机自启动的时候，有出现服务注册不了的情况，按道理这时候A服务器上的业务应用的责任节点应该都重新分配到B的nacos节点上了才对，但是看nacos server的日志报了一个receive invalid redirect request from peer {ip} ,这种看源码应该是两个nacos节点计算责任节点出现不一致导致的，但是这里我一直搞不明白为什么会出现这种不一致？ nacos-opensource 

---------------
## 专家官方解答 ：

首先，针对您描述的问题，即在进行高可用测试时，模拟服务器断电重启后，A服务器上的业务应用出现服务注册失败，并且Nacos Server日志中报出“receive invalid redirect request from peer {ip}”错误，这可能的原因可以从以下几个方面进行分析：

1. **Nacos节点间通信问题**：在您的集群环境中，Nacos节点间应保持正常通信以同步服务元数据及责任节点信息。当A服务器重启并试图重新加入集群时，若节点间通信存在问题，可能导致责任节点计算不一致。这可能是由于网络波动、防火墙规则、端口限制等因素导致的。我了解的知识中虽未直接提及此情况，但“网络问题”是可能导致服务发现异常的一个重要原因。

2. **Nacos节点状态同步滞后**：在A服务器断电重启过程中，B服务器作为唯一UP状态的节点，应接管所有服务的注册与发现。然而，若A服务器上的业务应用在节点状态尚未完全同步至B节点（如A节点状态尚处于SUSPICIOUS或DOWN，而B节点未及时感知）时尝试注册，可能会引发责任节点计算不一致。

3. **Nacos版本兼容性或bug**：您提到的现象涉及节点间的责任节点计算逻辑，如果使用的Nacos版本存在特定的兼容性问题或已知bug，可能导致节点间状态同步及责任节点计算出错。我了解的知识中提到过某些特定版本（如Dubbo 2.7.7~2.7.16）存在可能导致服务发现异常的问题，尽管此处未明确指出与您遇到的“invalid redirect request”错误直接相关，但版本问题仍值得考虑。

基于以上分析，针对问题原因，结合我了解的知识中提供的排查思路，可以按照以下步骤进行详细排查与解决：

**步骤1：检查Nacos节点间网络通信**

1.1. 确认各节点间Nacos服务通信端口（默认为8848）是否开放且无防火墙阻挡。

1.2. 在Nacos节点的日志中查找与节点间通信相关的异常信息，如连接超时、拒绝连接等。

1.3. 如果存在网络问题，修复相应网络配置或防火墙规则，确保节点间通信正常。

**步骤2：观察Nacos节点状态变化**

2.1. 在Nacos控制台上实时监控节点状态变化，特别是在A服务器重启过程中，注意观察A节点状态何时从DOWN转变为UP，以及期间B节点是否能及时响应并接管全部服务。

2.2. 分析Nacos节点日志，关注节点状态变化的时间点，以及与之相关的同步消息记录，判断节点间状态同步是否存在滞后现象。

**步骤3：检查并升级Nacos版本**

3.1. 确认当前使用的Nacos Server及客户端版本，查阅官方文档或社区论坛，了解是否存在已知的与节点间通信或责任节点计算相关的问题。

3.2. 如发现存在已知问题或版本较旧，考虑升级至稳定版或已修复相关问题的新版本，以排除版本因素导致的问题。

**步骤4：深入分析“invalid redirect request”错误**

4.1. 查阅Nacos源码或相关技术文档，理解“invalid redirect request”错误的具体含义及其触发条件。

4.2. 在Nacos节点日志中寻找更详细的上下文信息，如错误发生的具体时间、涉及的服务、节点状态等，有助于进一步定位问题根源。

4.3. 如果问题仍未解决，可在Nacos社区或相关技术论坛提交问题详细描述及日志信息，寻求官方或社区专家的帮助。

综上所述，针对您在高可用测试中遇到的Nacos服务注册问题，首先应从节点间网络通信、节点状态同步以及Nacos版本这三个方面进行排查。根据排查结果，采取相应的措施（如修复网络问题、优化节点状态同步机制、升级Nacos版本等），并深入分析“invalid redirect request”错误以彻底解决问题。


<font color="#949494">---------------</font> 


## 参考链接 ：

*专家经验:服务提供者已关闭，但是还在被其他应用调用 
 
 *专家经验:应用服务调用了依赖服务的提供者时，提示No provider或找不到服务等错误。 
 
 *[Nacos功能和需求列表](https://nacos.io/docs/latest/archive/feature-list)


 <font color="#949494">---------------</font> 
 


## <font color="#FF0000">答疑服务说明：</font> 

本内容经由技术专家审阅的用户问答的镜像生成，我们提供了<font color="#FF0000">专家智能答疑服务</font>，在<font color="#FF0000">页面的右下的浮窗”专家答疑“</font>。您也可以访问 : [全局专家答疑](https://opensource.alibaba.com/chatBot) 。 咨询其他产品的的问题

### 反馈
如问答有错漏，欢迎点：[差评](https://ai.nacos.io/user/feedbackByEnhancerGradePOJOID?enhancerGradePOJOId=11613)给我们反馈。
