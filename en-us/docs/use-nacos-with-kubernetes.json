{
  "filename": "use-nacos-with-kubernetes.md",
  "__html": "<h1>Kubernetes Nacos</h1>\n<p>����Ŀ����һ���ɹ�����Nacos Docker Image,ּ������StatefulSets��<a href=\"https://kubernetes.io/\">Kubernetes</a>�ϲ���<a href=\"https://nacos.io\">Nacos</a></p>\n<p><a href=\"https://github.com/nacos-group/nacos-k8s/blob/master/README.md\">English Document</a></p>\n<h1>���ٿ�ʼ</h1>\n<ul>\n<li><strong>Clone ��Ŀ</strong></li>\n</ul>\n<pre><code class=\"language-shell\">git clone https://github.com/nacos-group/nacos-k8s.git\n</code></pre>\n<ul>\n<li><strong>������</strong></li>\n</ul>\n<blockquote>\n<p>�����ʹ�ü򵥷�ʽ������,��ע������û��ʹ�ó־û����,���ܴ������ݶ�ʧ����:</p>\n</blockquote>\n<pre><code class=\"language-shell\">cd nacos-k8s\nchmod +x quick-startup.sh\n./quick-startup.sh\n</code></pre>\n<ul>\n<li>\n<p><strong>����</strong></p>\n<ul>\n<li><strong>����ע��</strong></li>\n</ul>\n<pre><code class=\"language-bash\">curl -X PUT <span class=\"hljs-string\">'http://cluster-ip:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080'</span>\n</code></pre>\n<ul>\n<li><strong>������</strong></li>\n</ul>\n<pre><code class=\"language-bash\">curl -X GET <span class=\"hljs-string\">'http://cluster-ip:8848/nacos/v1/ns/instances?serviceName=nacos.naming.serviceName'</span>\n</code></pre>\n<ul>\n<li><strong>��������</strong></li>\n</ul>\n<pre><code class=\"language-bash\">curl -X POST <span class=\"hljs-string\">\"http://cluster-ip:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;content=helloWorld\"</span>\n</code></pre>\n<ul>\n<li><strong>��ȡ����</strong></li>\n</ul>\n<pre><code class=\"language-bash\">curl -X GET <span class=\"hljs-string\">\"http://cluster-ip:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test\"</span>\n</code></pre>\n</li>\n</ul>\n<h1>�߼�ʹ��</h1>\n<blockquote>\n<p>�ڸ߼�ʹ����,Nacos��K8Sӵ���Զ��������ݺ����ݳ־�����,��ע�������Ҫʹ���ⲿ�ֹ�����ʹ��PVC�־þ�,Nacos���Զ�����������Ҫ�����־þ�,�Լ����ݳ־û�Ҳ��һ��,������ʹ�õ���NFS��ʹ��PVC.</p>\n</blockquote>\n<h2>���� NFS</h2>\n<ul>\n<li>������ɫ</li>\n</ul>\n<pre><code class=\"language-shell\">kubectl create -f deploy/nfs/rbac.yaml\n</code></pre>\n<blockquote>\n<p>�����K8S�����ռ䲻��<strong>default</strong>,���ڲ���RBAC֮ǰִ�����½ű�:</p>\n</blockquote>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">#</span><span class=\"bash\"> Set the subject of the RBAC objects to the current namespace <span class=\"hljs-built_in\">where</span> the provisioner is being deployed</span>\n<span class=\"hljs-meta\">$</span><span class=\"bash\"> NS=$(kubectl config get-contexts|grep -e <span class=\"hljs-string\">\"^\\*\"</span> |awk <span class=\"hljs-string\">'{print $5}'</span>)</span>\n<span class=\"hljs-meta\">$</span><span class=\"bash\"> NAMESPACE=<span class=\"hljs-variable\">${NS:-default}</span></span>\n<span class=\"hljs-meta\">$</span><span class=\"bash\"> sed -i<span class=\"hljs-string\">''</span> <span class=\"hljs-string\">\"s/namespace:.*/namespace: <span class=\"hljs-variable\">$NAMESPACE</span>/g\"</span> ./deploy/nfs/rbac.yaml</span>\n\n</code></pre>\n<ul>\n<li>���� <code>ServiceAccount</code> �Ͳ��� <code>NFS-Client Provisioner</code></li>\n</ul>\n<pre><code class=\"language-shell\">kubectl create -f deploy/nfs/deployment.yaml\n</code></pre>\n<ul>\n<li>���� NFS StorageClass</li>\n</ul>\n<pre><code class=\"language-shell\">kubectl create -f deploy/nfs/class.yaml\n</code></pre>\n<ul>\n<li>��֤NFS����ɹ�</li>\n</ul>\n<pre><code class=\"language-shell\">kubectl get pod -l app=nfs-client-provisioner\n</code></pre>\n<h2>�������ݿ�</h2>\n<ul>\n<li>��������</li>\n</ul>\n<pre><code class=\"language-shell\">\ncd nacos-k8s\n\nkubectl create -f deploy/mysql/mysql-master-nfs.yaml\n</code></pre>\n<ul>\n<li>����ӿ�</li>\n</ul>\n<pre><code class=\"language-shell\">\ncd nacos-k8s \n\nkubectl create -f deploy/mysql/mysql-slave-nfs.yaml\n</code></pre>\n<ul>\n<li>��֤���ݿ��Ƿ���������</li>\n</ul>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">#</span><span class=\"bash\"> master</span>\nkubectl get pod \nNAME                         READY   STATUS    RESTARTS   AGE\nmysql-master-gf2vd                        1/1     Running   0          111m\n<span class=\"hljs-meta\">\n#</span><span class=\"bash\"> slave</span>\nkubectl get pod \nmysql-slave-kf9cb                         1/1     Running   0          110m\n</code></pre>\n<h2>����Nacos</h2>\n<ul>\n<li>�޸�  <strong>depoly/nacos/nacos-pvc-nfs.yaml</strong></li>\n</ul>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">data:</span>\n  <span class=\"hljs-string\">mysql.master.db.name:</span> <span class=\"hljs-string\">\"��������\"</span>\n  <span class=\"hljs-string\">mysql.master.port:</span> <span class=\"hljs-string\">\"����˿�\"</span>\n  <span class=\"hljs-string\">mysql.slave.port:</span> <span class=\"hljs-string\">\"�ӿ�˿�\"</span>\n  <span class=\"hljs-string\">mysql.master.user:</span> <span class=\"hljs-string\">\"�����û���\"</span>\n  <span class=\"hljs-string\">mysql.master.password:</span> <span class=\"hljs-string\">\"��������\"</span>\n</code></pre>\n<ul>\n<li>���� Nacos</li>\n</ul>\n<pre><code class=\"language-shell\">kubectl create -f nacos-k8s/deploy/nacos/nacos-pvc-nfs.yaml\n</code></pre>\n<ul>\n<li>��֤Nacos�ڵ���ɹ�</li>\n</ul>\n<pre><code class=\"language-shell\">kubectl get pod -l app=nacos\n\n\nNAME      READY   STATUS    RESTARTS   AGE\nnacos-0   1/1     Running   0          19h\nnacos-1   1/1     Running   0          19h\nnacos-2   1/1     Running   0          19h\n</code></pre>\n<h2>���ݲ���</h2>\n<ul>\n<li>������ǰ,ʹ�� <a href=\"https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#exec\"><code>kubectl exec</code></a>��ȡ��pod�е�Nacos��Ⱥ�����ļ���Ϣ</li>\n</ul>\n<pre><code class=\"language-powershell\"><span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">1</span>; <span class=\"hljs-keyword\">do</span> echo nacos-<span class=\"hljs-variable\">$i</span>; kubectl exec nacos-<span class=\"hljs-variable\">$i</span> cat conf/cluster.conf; done\n</code></pre>\n<p>StatefulSet��������������������Ϊÿ��Pod�ṩΨһ���������� ����������<statefulset name>  -  <ordinal index>����ʽ�� ��Ϊnacos StatefulSet�ĸ����ֶ�����Ϊ2�����Ե�ǰ��Ⱥ�ļ���ֻ������Nacos�ڵ��ַ</p>\n<p><img src=\"/images/k8s.gif\" alt=\"k8s\"></p>\n<ul>\n<li>ʹ��kubectl scale ��Nacos��̬����</li>\n</ul>\n<pre><code class=\"language-bash\">kubectl scale sts nacos --replicas=3\n</code></pre>\n<p><img src=\"/images/scale.gif\" alt=\"scale\"></p>\n<ul>\n<li>�����ݺ�,ʹ�� <a href=\"https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#exec\"><code>kubectl exec</code></a>��ȡ��pod�е�Nacos��Ⱥ�����ļ���Ϣ</li>\n</ul>\n<pre><code class=\"language-bash\"><span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> 0 1 2; <span class=\"hljs-keyword\">do</span> <span class=\"hljs-built_in\">echo</span> nacos-<span class=\"hljs-variable\">$i</span>; kubectl <span class=\"hljs-built_in\">exec</span> nacos-<span class=\"hljs-variable\">$i</span> cat conf/cluster.conf; <span class=\"hljs-keyword\">done</span>\n</code></pre>\n<p><img src=\"/images/get_cluster_after.gif\" alt=\"get_cluster_after\"></p>\n<ul>\n<li>ʹ�� <a href=\"https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#exec\"><code>kubectl exec</code></a>ִ��Nacos API ��ÿ̨�ڵ��ϻ�ȡ��ǰ<strong>Leader</strong>�Ƿ�һ��</li>\n</ul>\n<pre><code class=\"language-bash\"><span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> 0 1 2; <span class=\"hljs-keyword\">do</span> <span class=\"hljs-built_in\">echo</span> nacos-<span class=\"hljs-variable\">$i</span>; kubectl <span class=\"hljs-built_in\">exec</span> nacos-<span class=\"hljs-variable\">$i</span> curl GET <span class=\"hljs-string\">\"http://localhost:8848/nacos/v1/ns/raft/state\"</span>; <span class=\"hljs-keyword\">done</span>\n</code></pre>\n<p>����������Է����½ڵ��Ѿ���������Nacos��Ⱥ����</p>\n<h1>���Ӳ��𻷾�</h1>\n<ul>\n<li>��������</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>����IP</th>\n<th>������</th>\n<th>����</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>172.17.79.3</td>\n<td>k8s-master</td>\n<td>CentOS Linux release 7.4.1708 (Core) Single-core processor Mem 4G Cloud disk 40G</td>\n</tr>\n<tr>\n<td>172.17.79.4</td>\n<td>node01</td>\n<td>CentOS Linux release 7.4.1708 (Core) Single-core processor Mem 4G Cloud disk 40G</td>\n</tr>\n<tr>\n<td>172.17.79.5</td>\n<td>node02</td>\n<td>CentOS Linux release 7.4.1708 (Core) Single-core processor Mem 4G Cloud disk 40G</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>Kubernetes �汾��<strong>1.12.2</strong> ����������һ��ֻʹ������̨����,��ô�ǵÿ���master�ڵ�Ĳ����ܣ�</li>\n<li>NFS �汾��<strong>4.1</strong> ��k8s-master���а�װServer��,����ָ������Ŀ¼,����Ŀָ����**/data/nfs-share**</li>\n<li>Git</li>\n</ul>\n<h1>����</h1>\n<ul>\n<li>����Ҫʹ�ó־þ�,�����������ݶ�ʧ�����</li>\n</ul>\n<h1>��ĿĿ¼</h1>\n<table>\n<thead>\n<tr>\n<th>Ŀ¼</th>\n<th>����</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>plugin</td>\n<td>����Nacos��Ⱥ���ж�̬���ݵĲ��Docker����Դ��</td>\n</tr>\n<tr>\n<td>deploy</td>\n<td>K8s �����ļ�</td>\n</tr>\n</tbody>\n</table>\n<h1>��������</h1>\n<ul>\n<li>nacos-pvc-nfs.yaml or nacos-quick-start.yaml</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>����</th>\n<th>��Ҫ</th>\n<th>����</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><a href=\"http://mysql.master.db.name\">mysql.master.db.name</a></td>\n<td>Y</td>\n<td>��������</td>\n</tr>\n<tr>\n<td>mysql.master.port</td>\n<td>N</td>\n<td>����˿�</td>\n</tr>\n<tr>\n<td>mysql.slave.port</td>\n<td>N</td>\n<td>�ӿ�˿�</td>\n</tr>\n<tr>\n<td>mysql.master.user</td>\n<td>Y</td>\n<td>�����û���</td>\n</tr>\n<tr>\n<td>mysql.master.password</td>\n<td>Y</td>\n<td>��������</td>\n</tr>\n<tr>\n<td>NACOS_REPLICAS</td>\n<td>N</td>\n<td>ȷ��ִ��Nacos��ڵ�����,��������ö�̬���ݲ��,�ͱ�������������ԣ�����ʹ�����ݲ���󲻻���Ч</td>\n</tr>\n<tr>\n<td>NACOS_SERVER_PORT</td>\n<td>N</td>\n<td>Nacos �˿�</td>\n</tr>\n<tr>\n<td>PREFER_HOST_MODE</td>\n<td>Y</td>\n<td>��Nacos��Ⱥ����������</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li><strong>nfs</strong> deployment.yaml</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>����</th>\n<th>��Ҫ</th>\n<th>����</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>NFS_SERVER</td>\n<td>Y</td>\n<td>NFS ����˵�ַ</td>\n</tr>\n<tr>\n<td>NFS_PATH</td>\n<td>Y</td>\n<td>NFS ����Ŀ¼</td>\n</tr>\n<tr>\n<td>server</td>\n<td>Y</td>\n<td>NFS ����˵�ַ</td>\n</tr>\n<tr>\n<td>path</td>\n<td>Y</td>\n<td>NFS ����Ŀ¼</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>mysql</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>����</th>\n<th>��Ҫ</th>\n<th>����</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>MYSQL_ROOT_PASSWORD</td>\n<td>N</td>\n<td>ROOT ����</td>\n</tr>\n<tr>\n<td>MYSQL_DATABASE</td>\n<td>Y</td>\n<td>���ݿ�����</td>\n</tr>\n<tr>\n<td>MYSQL_USER</td>\n<td>Y</td>\n<td>���ݿ��û���</td>\n</tr>\n<tr>\n<td>MYSQL_PASSWORD</td>\n<td>Y</td>\n<td>���ݿ�����</td>\n</tr>\n<tr>\n<td>MYSQL_REPLICATION_USER</td>\n<td>Y</td>\n<td>���ݿ⸴���û�</td>\n</tr>\n<tr>\n<td>MYSQL_REPLICATION_PASSWORD</td>\n<td>Y</td>\n<td>���ݿ⸴���û�����</td>\n</tr>\n<tr>\n<td>Nfs:server</td>\n<td>N</td>\n<td>NFS ����˵�ַ�����ʹ�ñ��ز�����Ҫ����</td>\n</tr>\n<tr>\n<td>Nfs:path</td>\n<td>N</td>\n<td>NFS ����Ŀ¼�����ʹ�ñ��ز�����Ҫ����</td>\n</tr>\n</tbody>\n</table>\n"
}